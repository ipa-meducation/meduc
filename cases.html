<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cases Maker - mEducation Hub</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-green: #49ac57;
            --dark-green: #155240;
            --light-blue: #84d0d4;
            --dark-blue: #2b4085;
            --orange: #f26529;
            --light-gray: #f1f2f2;
            --dark-gray: #414042;
            --charcoal: #414042;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            min-height: 100vh;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--dark-green);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .subtitle {
            color: var(--charcoal);
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .back-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: var(--dark-green);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-section, .preview-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.4rem;
            color: var(--dark-green);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--primary-green);
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed var(--light-blue);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(132, 208, 212, 0.1);
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary-green);
            background: rgba(73, 172, 87, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--orange);
            background: rgba(242, 101, 41, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--light-blue);
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: var(--charcoal);
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: var(--dark-gray);
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: var(--dark-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--dark-blue);
        }

        .btn-secondary:hover {
            background: var(--light-blue);
            color: var(--dark-green);
        }

        .btn-orange {
            background: var(--orange);
        }

        .btn-orange:hover {
            background: #d94d1a;
        }

        .file-info {
            background: rgba(73, 172, 87, 0.1);
            border: 1px solid var(--primary-green);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--primary-green);
        }

        .file-name {
            font-weight: 600;
            color: var(--dark-green);
        }

        .file-size {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .mapping-section {
            margin-top: 20px;
            display: none;
        }

        .mapping-section.show {
            display: block;
        }

        .mapping-title {
            font-size: 1.2rem;
            color: var(--dark-green);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-mapping {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mapping-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mapping-label {
            font-weight: 600;
            color: var(--dark-green);
            font-size: 0.9rem;
        }

        .mapping-select {
            padding: 10px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .mapping-select:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .preview-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow: auto;
            max-height: 500px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--primary-green);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(73, 172, 87, 0.1);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .help-section {
            background: rgba(132, 208, 212, 0.1);
            border: 1px solid var(--light-blue);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .help-title {
            font-size: 1.1rem;
            color: var(--dark-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-list {
            list-style: none;
            padding-left: 0;
        }

        .help-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .help-list li::before {
            content: "→";
            color: var(--light-blue);
            font-weight: bold;
            flex-shrink: 0;
        }

        .error-message {
            background: rgba(242, 101, 41, 0.1);
            border: 1px solid var(--orange);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: var(--dark-gray);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: rgba(73, 172, 87, 0.1);
            border: 1px solid var(--primary-green);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: var(--dark-green);
            display: none;
        }

        .success-message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .back-btn {
                position: static;
                transform: none;
                margin-top: 15px;
            }
            
            h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .column-mapping {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .upload-section, .preview-section {
                padding: 20px;
            }
        }

        /* Animation for page load */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section,
        .preview-section,
        .stats-section {
            animation: fadeInUp 0.6s ease forwards;
        }

        .upload-section { animation-delay: 0.1s; }
        .preview-section { animation-delay: 0.2s; }
        .stats-section { animation-delay: 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <i class="fas fa-file-medical"></i>
                Cases Maker
            </h1>
            <div class="subtitle">Create cases for SurveyCTO, derived from learners info dataset</div>
            <a href="home.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Hub
            </a>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <div class="section-title">
                    <i class="fas fa-upload"></i>
                    Upload Learner Data
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drop your Excel or CSV file here</div>
                    <div class="upload-subtext">or click to browse files</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                </div>

                <div class="file-info" id="fileInfo">
                    <div class="file-details">
                        <i class="fas fa-file-excel file-icon"></i>
                        <div>
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileSize"></div>
                        </div>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <div class="mapping-section" id="mappingSection">
                    <div class="mapping-title">
                        <i class="fas fa-exchange-alt"></i>
                        Column Mapping
                    </div>
                    <div class="column-mapping" id="columnMapping">
                        <!-- Dynamic mapping fields will be added here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn" id="processBtn" disabled>
                            <i class="fas fa-cogs"></i>
                            Process Data
                        </button>
                        <button class="btn btn-secondary" id="resetBtn">
                            <i class="fas fa-undo"></i>
                            Reset
                        </button>
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-title">
                        <i class="fas fa-info-circle"></i>
                        Expected File Format
                    </div>
                    <ul class="help-list">
                        <li>Excel (.xlsx) or CSV file with learner enrollment data</li>
                        <li>Should contain student names, grades, teacher info, school details</li>
                        <li>Contact information (phone numbers, respondent details)</li>
                        <li>School Division Office (SDO) information</li>
                        <li>File should be from SurveyCTO learner enrollment form export</li>
                    </ul>
                </div>
            </div>

            <div class="preview-section">
                <div class="section-title">
                    <i class="fas fa-eye"></i>
                    Preview & Download
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Processing your data...</div>
                </div>

                <div class="preview-area" id="previewArea">
                    Upload a file to see the preview of generated cases...
                </div>

                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-orange" id="downloadBtn" disabled>
                        <i class="fas fa-download"></i>
                        Download Cases Excel
                    </button>
                    <button class="btn btn-secondary" id="previewDetailsBtn" disabled>
                        <i class="fas fa-table"></i>
                        View Full Details
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-section" id="statsSection" style="display: none;">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                Processing Statistics
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueStudents">0</div>
                    <div class="stat-label">Unique Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTeachers">0</div>
                    <div class="stat-label">Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSchools">0</div>
                    <div class="stat-label">Schools</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSDOs">0</div>
                    <div class="stat-label">SDOs</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rawData = null;
        let processedData = null;
        let columnHeaders = [];
        let requiredFields = {
            'stud_firstname_': 'Student First Name',
            'stud_lastname_': 'Student Last Name', 
            'grade_level_': 'Grade Level',
            'teacher_firstname': 'Teacher First Name',
            'teacher_lastname': 'Teacher Last Name',
            'school': 'School Name',
            'sdo': 'School Division Office',
            'resp_firstname_': 'Respondent First Name',
            'resp_lastname_': 'Respondent Last Name',
            'phone_1_': 'Primary Phone',
            'learn_number_': 'Learner Number'
        };

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const mappingSection = document.getElementById('mappingSection');
        const columnMapping = document.getElementById('columnMapping');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const previewArea = document.getElementById('previewArea');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statsSection = document.getElementById('statsSection');

        // Event listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processData);
        resetBtn.addEventListener('click', resetForm);
        downloadBtn.addEventListener('click', downloadExcel);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel',
                'text/csv'
            ];
            
            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                showError('Please upload a valid Excel (.xlsx, .xls) or CSV file.');
                return;
            }

            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            hideMessages();

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        parseCSV(e.target.result);
                    } else {
                        parseExcel(e.target.result);
                    }
                } catch (error) {
                    showError('Error reading file: ' + error.message);
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                showError('CSV file must have at least a header row and one data row.');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }

            rawData = data;
            columnHeaders = headers;
            setupColumnMapping();
        }

        function parseExcel(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const data = XLSX.utils.sheet_to_json(worksheet);

            if (data.length === 0) {
                showError('Excel file appears to be empty or has no data rows.');
                return;
            }

            rawData = data;
            columnHeaders = Object.keys(data[0]);
            setupColumnMapping();
        }

        function setupColumnMapping() {
            columnMapping.innerHTML = '';
            
            Object.keys(requiredFields).forEach(field => {
                const mappingGroup = document.createElement('div');
                mappingGroup.className = 'mapping-group';
                
                const label = document.createElement('div');
                label.className = 'mapping-label';
                label.textContent = requiredFields[field];
                
                const select = document.createElement('select');
                select.className = 'mapping-select';
                select.id = `mapping_${field}`;
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select Column --';
                select.appendChild(defaultOption);
                
                // Add column options
                columnHeaders.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    
                    // Auto-select if column name matches
                    if (header.toLowerCase().includes(field.toLowerCase()) ||
                        field.toLowerCase().includes(header.toLowerCase())) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
                
                mappingGroup.appendChild(label);
                mappingGroup.appendChild(select);
                columnMapping.appendChild(mappingGroup);
            });

            mappingSection.classList.add('show');
            processBtn.disabled = false;
        }

        function processData() {
            // Get column mappings
            const mappings = {};
            let hasRequiredMappings = true;
            
            Object.keys(requiredFields).forEach(field => {
                const selectElement = document.getElementById(`mapping_${field}`);
                mappings[field] = selectElement.value;
                
                if (!mappings[field] && ['stud_firstname_', 'stud_lastname_', 'school', 'sdo'].includes(field)) {
                    hasRequiredMappings = false;
                }
            });

            if (!hasRequiredMappings) {
                showError('Please map at least Student First Name, Student Last Name, School, and SDO fields.');
                return;
            }

            showLoading(true);
            
            // Simulate processing delay for better UX
            setTimeout(() => {
                try {
                    processedData = transformData(rawData, mappings);
                    showLoading(false);
                    updatePreview();
                    updateStats();
                    downloadBtn.disabled = false;
                    showSuccess('Data processed successfully! You can now download the Excel file.');
                    statsSection.style.display = 'block';
                } catch (error) {
                    showLoading(false);
                    showError('Error processing data: ' + error.message);
                }
            }, 1500);
        }

        function transformData(data, mappings) {
            const result = {
                cases: [],
                teachers: [],
                schools: []
            };

            const teacherSet = new Set();
            const schoolSet = new Set();
            const sdoSet = new Set();

            data.forEach((row, index) => {
                // Skip empty rows
                if (!row[mappings.stud_firstname_] && !row[mappings.stud_lastname_]) {
                    return;
                }

                // Process case data
                const caseData = {
                    formids: 'deped_nlc_baseline_form, deped_nlc_phone_change',
                    region: row[mappings.region] || '',
                    division: row[mappings.sdo] || '',
                    school_name: row[mappings.school] || '',
                    old_student_name: `${(row[mappings.stud_firstname_] || '').trim()} ${(row[mappings.stud_lastname_] || '').trim()}`.trim(),
                    grade_level: row[mappings.grade_level_] || '',
                    resp_name: `${(row[mappings.resp_firstname_] || '').trim()} ${(row[mappings.resp_lastname_] || '').trim()}`.trim(),
                    resp_relation: 'Parent', // Default, can be enhanced
                    encoding_teacher: `${(row[mappings.teacher_firstname] || '').trim()} ${(row[mappings.teacher_lastname] || '').trim()}`.trim(),
                    phone_1: row[mappings.phone_1_] || '',
                    phone_2: row[mappings.phone_2_] || '',
                    phone_1_name: `${(row[mappings.resp_firstname_] || '').trim()} ${(row[mappings.resp_lastname_] || '').trim()}`.trim(),
                    phone_2_name: row[mappings.phone_2_] ? `${(row[mappings.resp_firstname_] || '').trim()} ${(row[mappings.resp_lastname_] || '').trim()}`.trim() : '',
                    learn_number: row[mappings.learn_number_] || '',
                    contacts: row[mappings.contacts] || ''
                };

                result.cases.push(caseData);

                // Collect unique teachers
                if (caseData.encoding_teacher && caseData.encoding_teacher.trim()) {
                    teacherSet.add(JSON.stringify({
                        sdo: caseData.division,
                        school_name: caseData.school_name,
                        teacher_name: caseData.encoding_teacher,
                        teacher_firstname: row[mappings.teacher_firstname] || '',
                        teacher_lastname: row[mappings.teacher_lastname] || ''
                    }));
                }

                // Collect unique schools
                if (caseData.school_name && caseData.school_name.trim()) {
                    schoolSet.add(JSON.stringify({
                        sdo: caseData.division,
                        school_name: caseData.school_name
                    }));
                }

                sdoSet.add(caseData.division);
            });

            // Convert sets to arrays
            result.teachers = Array.from(teacherSet).map(JSON.parse);
            result.schools = Array.from(schoolSet).map(JSON.parse);
            result.sdos = Array.from(sdoSet).filter(sdo => sdo);

            return result;
        }

        function updatePreview() {
            if (!processedData) return;

            const preview = `CASES DATA PREVIEW:
===================

Total Cases: ${processedData.cases.length}
Total Teachers: ${processedData.teachers.length}
Total Schools: ${processedData.schools.length}
SDOs: ${processedData.sdos.join(', ')}

SAMPLE CASES (First 3):
${processedData.cases.slice(0, 3).map((c, i) => `
Case ${i + 1}:
  Student: ${c.old_student_name}
  Grade: ${c.grade_level}
  School: ${c.school_name}
  Teacher: ${c.encoding_teacher}
  Respondent: ${c.resp_name}
  Phone: ${c.phone_1}
`).join('')}

SAMPLE TEACHERS (First 3):
${processedData.teachers.slice(0, 3).map((t, i) => `
Teacher ${i + 1}:
  Name: ${t.teacher_name}
  School: ${t.school_name}
  SDO: ${t.sdo}
`).join('')}

Ready to download Excel file with:
- Individual SDO sheets for cases
- Teachers sheet with enumerator IDs  
- Schools sheet for reference
- Built-in formulas for ID generation
- Conditional formatting for duplicate detection`;

            previewArea.textContent = preview;
        }

        function updateStats() {
            if (!processedData) return;

            document.getElementById('totalRecords').textContent = processedData.cases.length;
            document.getElementById('uniqueStudents').textContent = new Set(processedData.cases.map(c => c.old_student_name)).size;
            document.getElementById('totalTeachers').textContent = processedData.teachers.length;
            document.getElementById('totalSchools').textContent = processedData.schools.length;
            document.getElementById('totalSDOs').textContent = processedData.sdos.length;
        }

        function downloadExcel() {
            if (!processedData) return;

            showLoading(true);
            
            // Simulate Excel generation delay
            setTimeout(() => {
                try {
                    generateExcelFile();
                    showLoading(false);
                    showSuccess('Excel file downloaded successfully!');
                } catch (error) {
                    showLoading(false);
                    showError('Error generating Excel file: ' + error.message);
                }
            }, 2000);
        }

        function generateExcelFile() {
            const wb = XLSX.utils.book_new();
            
            // Create teachers sheet
            const teachersData = processedData.teachers.map((teacher, index) => ({
                'sdoid': '', // To be filled manually or from lookup
                'sdo': teacher.sdo,
                'school_name': teacher.school_name,
                'teacher_first_name': teacher.teacher_firstname,
                'teacher_last_name': teacher.teacher_lastname,
                'enumerator_id': '', // Formula will generate this
                'enumerator_name': '', // Formula will generate this
                'users': '' // To be looked up from schools sheet
            }));
            
            const teachersWS = XLSX.utils.json_to_sheet(teachersData);
            XLSX.utils.book_append_sheet(wb, teachersWS, 'teachers');
            
            // Create schools sheet
            const schoolsData = processedData.schools.map(school => ({
                'sdo': school.sdo,
                'district': '', // To be filled manually
                'school_name': school.school_name,
                'users': '' // To be filled from login credentials
            }));
            
            const schoolsWS = XLSX.utils.json_to_sheet(schoolsData);
            XLSX.utils.book_append_sheet(wb, schoolsWS, 'schools');
            
            // Create SDO-specific sheets for cases
            processedData.sdos.forEach(sdo => {
                if (!sdo) return;
                
                const sdoCases = processedData.cases.filter(c => c.division === sdo);
                const sdoData = sdoCases.map((caseItem, index) => ({
                    'id': '', // Formula will generate this
                    'formids': caseItem.formids,
                    'region': caseItem.region,
                    'division': caseItem.division,
                    'school_name': caseItem.school_name,
                    'resp_name': caseItem.resp_name,
                    'resp_relation': caseItem.resp_relation,
                    'old_student_name': caseItem.old_student_name,
                    'grade_level': caseItem.grade_level,
                    'encoding_teacher': caseItem.encoding_teacher,
                    'contacts': caseItem.contacts,
                    'phone_1': caseItem.phone_1,
                    'phone_2': caseItem.phone_2,
                    'phone_1_name': caseItem.phone_1_name,
                    'phone_2_name': caseItem.phone_2_name,
                    'enumerators': '', // Formula will generate this
                    'users': '' // Formula will generate this
                }));
                
                const sdoWS = XLSX.utils.json_to_sheet(sdoData);
                const sheetName = sdo.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 31);
                XLSX.utils.book_append_sheet(wb, sdoWS, sheetName);
            });
            
            // Download the file
            const fileName = `cases_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function resetForm() {
            rawData = null;
            processedData = null;
            columnHeaders = [];
            
            fileInfo.classList.remove('show');
            mappingSection.classList.remove('show');
            statsSection.style.display = 'none';
            
            processBtn.disabled = true;
            downloadBtn.disabled = true;
            
            previewArea.textContent = 'Upload a file to see the preview of generated cases...';
            hideMessages();
            
            fileInput.value = '';
        }

        function showLoading(show) {
            loading.classList.toggle('show', show);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            errorMessage.classList.remove('show');
        }

        function hideMessages() {
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
