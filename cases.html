<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cases Maker - mEducation Hub</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- SheetJS for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-green: #49ac57;
            --dark-green: #155240;
            --light-blue: #84d0d4;
            --dark-blue: #2b4085;
            --orange: #f26529;
            --light-gray: #f1f2f2;
            --dark-gray: #414042;
            --charcoal: #414042;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            min-height: 100vh;
            color: var(--charcoal);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--dark-green);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .subtitle {
            color: var(--charcoal);
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .back-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: var(--dark-green);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-section, .preview-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.4rem;
            color: var(--dark-green);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--primary-green);
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed var(--light-blue);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(132, 208, 212, 0.1);
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary-green);
            background: rgba(73, 172, 87, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--orange);
            background: rgba(242, 101, 41, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--light-blue);
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: var(--charcoal);
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: var(--dark-gray);
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: var(--dark-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--dark-blue);
        }

        .btn-secondary:hover {
            background: var(--light-blue);
            color: var(--dark-green);
        }

        .btn-orange {
            background: var(--orange);
        }

        .btn-orange:hover {
            background: #d94d1a;
        }

        .file-info {
            background: rgba(73, 172, 87, 0.1);
            border: 1px solid var(--primary-green);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--primary-green);
        }

        .file-name {
            font-weight: 600;
            color: var(--dark-green);
        }

        .file-size {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .mapping-section {
            margin-top: 20px;
            display: none;
        }

        .mapping-section.show {
            display: block;
        }

        .mapping-title {
            font-size: 1.2rem;
            color: var(--dark-green);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-mapping {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mapping-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mapping-label {
            font-weight: 600;
            color: var(--dark-green);
            font-size: 0.9rem;
        }

        .mapping-select {
            padding: 10px;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .mapping-select:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .preview-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow: auto;
            max-height: 500px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--primary-green);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(73, 172, 87, 0.1);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .help-section {
            background: rgba(132, 208, 212, 0.1);
            border: 1px solid var(--light-blue);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .help-title {
            font-size: 1.1rem;
            color: var(--dark-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-list {
            list-style: none;
            padding-left: 0;
        }

        .help-list li {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .help-list li::before {
            content: "→";
            color: var(--light-blue);
            font-weight: bold;
            flex-shrink: 0;
        }

        .error-message {
            background: rgba(242, 101, 41, 0.1);
            border: 1px solid var(--orange);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: var(--dark-gray);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: rgba(73, 172, 87, 0.1);
            border: 1px solid var(--primary-green);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: var(--dark-green);
            display: none;
        }

        .success-message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .back-btn {
                position: static;
                transform: none;
                margin-top: 15px;
            }
            
            h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .column-mapping {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .upload-section, .preview-section {
                padding: 20px;
            }
        }

        /* Animation for page load */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-section,
        .preview-section,
        .stats-section {
            animation: fadeInUp 0.6s ease forwards;
        }

        .upload-section { animation-delay: 0.1s; }
        .preview-section { animation-delay: 0.2s; }
        .stats-section { animation-delay: 0.3s; }

        .feature-doc-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-green);
        }

        .feature-doc-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-green);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-doc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feature-doc-list li {
            padding: 4px 0;
            color: var(--charcoal);
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .feature-doc-list li::before {
            content: "✓";
            color: var(--primary-green);
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .feature-doc-list code {
            background: rgba(73, 172, 87, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--dark-green);
        }

        @media (max-width: 768px) {
            .feature-doc-card {
                padding: 15px;
            }
            
            .feature-doc-title {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <i class="fas fa-file-medical"></i>
                Cases Maker
            </h1>
            <div class="subtitle">Create cases for SurveyCTO, derived from learners info dataset</div>
            <a href="home.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Hub
            </a>
        </header>

        <div class="main-content">
            <div class="upload-section">
                <div class="section-title">
                    <i class="fas fa-upload"></i>
                    Upload Learner Data
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drop your Excel or CSV file here</div>
                    <div class="upload-subtext">or click to browse files</div>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                </div>

                <div class="file-info" id="fileInfo">
                    <div class="file-details">
                        <i class="fas fa-file-excel file-icon"></i>
                        <div>
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileSize"></div>
                        </div>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <div class="mapping-section" id="mappingSection">
                    <div class="mapping-title">
                        <i class="fas fa-exchange-alt"></i>
                        Column Mapping
                    </div>
                    <div class="column-mapping" id="columnMapping">
                        <!-- Dynamic mapping fields will be added here -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn" id="processBtn" disabled>
                            <i class="fas fa-cogs"></i>
                            Process Data
                        </button>
                        <button class="btn btn-secondary" id="resetBtn">
                            <i class="fas fa-undo"></i>
                            Reset
                        </button>
                    </div>
                </div>

                <div class="help-section">
                    <div class="help-title">
                        <i class="fas fa-info-circle"></i>
                        Expected File Format
                    </div>
                    <ul class="help-list">
                        <li>Excel (.xlsx) or CSV file with learner enrollment data</li>
                        <li>Should contain student names, grades, teacher info, school details</li>
                        <li>Contact information (phone numbers, respondent details)</li>
                        <li>School Division Office (SDO) information</li>
                        <li>File should be from SurveyCTO learner enrollment form export (WIDE format)</li>
                    </ul>
                </div>
            </div>

            <div class="preview-section">
                <div class="section-title">
                    <i class="fas fa-eye"></i>
                    Preview & Download
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Processing your data...</div>
                </div>

                <div class="preview-area" id="previewArea">
                    Upload a file to see the preview of generated cases...
                </div>

                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-orange" id="downloadBtn" disabled>
                        <i class="fas fa-download"></i>
                        Download Cases Excel
                    </button>
                    <button class="btn btn-secondary" id="previewDetailsBtn" disabled>
                        <i class="fas fa-table"></i>
                        View Full Details
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-section" id="statsSection" style="display: none;">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                Processing Statistics
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueStudents">0</div>
                    <div class="stat-label">Unique Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTeachers">0</div>
                    <div class="stat-label">Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSchools">0</div>
                    <div class="stat-label">Schools</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSDOs">0</div>
                    <div class="stat-label">SDOs</div>
                </div>
            </div>
        </div>

        <!-- Data Processing Features Documentation -->
        <div class="stats-section" style="margin-top: 30px;">
            <div class="section-title">
                <i class="fas fa-cogs"></i>
                Data Processing Features
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-expand-arrows-alt"></i>
                        WIDE to LONG Format Conversion
                    </div>
                    <ul class="feature-doc-list">
                        <li>Automatically detects multiple students per row</li>
                        <li>Processes suffixes: <code>_</code>, <code>_1</code>, <code>_2</code>, etc.</li>
                        <li>Supports up to 30 students per row</li>
                        <li>Reshapes data from WIDE to LONG format for SurveyCTO</li>
                    </ul>
                </div>

                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-tags"></i>
                        Location Labels & IDs
                    </div>
                    <ul class="feature-doc-list">
                        <li>Uses text labels when available (region_label, sdo_label, etc.)</li>
                        <li>Preserves original IDs for reference</li>
                        <li>Maintains both ID and label data integrity</li>
                    </ul>
                </div>

                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-users"></i>
                        Relation Code Mapping
                    </div>
                    <ul class="feature-doc-list">
                        <li><strong>1:</strong> Parent</li>
                        <li><strong>2:</strong> Aunt/Uncle</li>
                        <li><strong>3:</strong> Grandparent</li>
                        <li><strong>4:</strong> Sibling</li>
                        <li><strong>5:</strong> Guardian</li>
                        <li><strong>6:</strong> Other Relative</li>
                    </ul>
                </div>

                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-user-check"></i>
                        Duplicate Detection & Prevention
                    </div>
                    <ul class="feature-doc-list">
                        <li>Student duplicates by: Name + Learner Number</li>
                        <li>Teacher duplicates by: Name + School ID</li>
                        <li>School duplicates by: School ID + SDO ID</li>
                        <li>Tracks and reports duplicates removed</li>
                    </ul>
                </div>

                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-font"></i>
                        Data Formatting & Cleaning
                    </div>
                    <ul class="feature-doc-list">
                        <li>Proper case formatting for all names</li>
                        <li>Phone number cleaning (removes non-digits)</li>
                        <li>Safe data type conversion (handles nulls/numbers)</li>
                        <li>Whitespace trimming and normalization</li>
                    </ul>
                </div>

                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-comments"></i>
                        Communication Platform Data
                    </div>
                    <ul class="feature-doc-list">
                        <li>Platform mapping: <strong>1:</strong> Phone call, <strong>2:</strong> Facebook Messenger audio call</li>
                        <li>Messenger account names captured</li>
                        <li>Messenger links included (Facebook profiles/pages)</li>
                    </ul>
                </div>
                <div class="feature-doc-card">
                    <div class="feature-doc-title">
                        <i class="fas fa-table"></i>
                        Enhanced Excel Output
                    </div>
                    <ul class="feature-doc-list">
                        <li><strong>Cases sheets:</strong> One per SDO with messenger & platform data</li>
                        <li><strong>Teachers sheet:</strong> Unique teachers with location labels</li>
                        <li><strong>Schools sheet:</strong> Complete location hierarchy</li>
                        <li><strong>Summary sheet:</strong> Detailed processing statistics</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rawData = null;
        let processedData = null;
        let columnHeaders = [];
        let requiredFields = {
            'stud_firstname_': 'Student First Name (first student)',
            'stud_lastname_': 'Student Last Name (first student)', 
            'grade_level_': 'Grade Level (first student)',
            'teacher_firstname': 'Teacher First Name',
            'teacher_lastname': 'Teacher Last Name',
            'school': 'School ID (numerical)',
            'sdo': 'SDO ID (numerical)',
            'region': 'Region ID (numerical)',
            'district': 'District ID (numerical)',
            'school_label': 'School Name (text label)',
            'sdo_label': 'SDO Name (text label)',
            'region_label': 'Region Name (text label)',
            'district_label': 'District Name (text label)',
            'resp_firstname_': 'Respondent First Name (first student)',
            'resp_lastname_': 'Respondent Last Name (first student)',
            'phone_1_': 'Primary Phone (first student)',
            'phone_2_': 'Secondary Phone (first student)',
            'learn_number_': 'Learner Number (first student)',
            'resp_relation_code_': 'Respondent Relation Code (first student)',
            'contacts_': 'Contacts (first student)',
            'messenger_acct_': 'Messenger Account (first student)',
            'messenger_link_': 'Messenger Link (first student)',
            'preferred_platform_': 'Preferred Platform Code (first student)'
        };

        // Priority mapping for better auto-selection
        const fieldPriorities = {
            'stud_firstname_': ['stud_firstname_'],
            'stud_lastname_': ['stud_lastname_'],
            'grade_level_': ['grade_level_'],
            'teacher_firstname': ['teacher_firstname'],
            'teacher_lastname': ['teacher_lastname'],
            'school': ['school'],
            'sdo': ['sdo'],
            'region': ['region'],
            'district': ['district'],
            'school_label': ['school_label'],
            'sdo_label': ['sdo_label'],
            'region_label': ['region_label'],
            'district_label': ['district_label'],
            'resp_firstname_': ['resp_firstname_'],
            'resp_lastname_': ['resp_lastname_'],
            'phone_1_': ['phone_1_'],
            'phone_2_': ['phone_2_'],
            'learn_number_': ['learn_number_'],
            'resp_relation_code_': ['resp_relation_code_'],
            'contacts_': ['contacts_'],
            'messenger_acct_': ['messenger_acct_'],
            'messenger_link_': ['messenger_link_'],
            'preferred_platform_': ['preferred_platform_']
        };

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const mappingSection = document.getElementById('mappingSection');
        const columnMapping = document.getElementById('columnMapping');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const previewArea = document.getElementById('previewArea');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statsSection = document.getElementById('statsSection');

        // Event listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processData);
        resetBtn.addEventListener('click', resetForm);
        downloadBtn.addEventListener('click', downloadExcel);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel',
                'text/csv'
            ];
            
            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                showError('Please upload a valid Excel (.xlsx, .xls) or CSV file.');
                return;
            }

            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            hideMessages();

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        parseCSV(e.target.result);
                    } else {
                        parseExcel(e.target.result);
                    }
                } catch (error) {
                    showError('Error reading file: ' + error.message);
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                showError('CSV file must have at least a header row and one data row.');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }

            rawData = data;
            columnHeaders = headers;
            setupColumnMapping();
        }

        function parseExcel(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const data = XLSX.utils.sheet_to_json(worksheet);

            if (data.length === 0) {
                showError('Excel file appears to be empty or has no data rows.');
                return;
            }

            rawData = data;
            columnHeaders = Object.keys(data[0]);
            setupColumnMapping();
        }

        function setupColumnMapping() {
            columnMapping.innerHTML = '';
            
            Object.keys(requiredFields).forEach(field => {
                const mappingGroup = document.createElement('div');
                mappingGroup.className = 'mapping-group';
                
                const label = document.createElement('div');
                label.className = 'mapping-label';
                label.textContent = requiredFields[field];
                
                const select = document.createElement('select');
                select.className = 'mapping-select';
                select.id = `mapping_${field}`;
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select Column --';
                select.appendChild(defaultOption);
                
                // Add column options
                columnHeaders.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
                
                // Auto-select using priority-based matching
                let bestMatch = '';
                if (fieldPriorities[field]) {
                    // First, try exact matches from priority list
                    for (let priority of fieldPriorities[field]) {
                        if (columnHeaders.includes(priority)) {
                            bestMatch = priority;
                            break;
                        }
                    }
                    
                    // If no exact match, try partial matching with priority order
                    if (!bestMatch) {
                        for (let priority of fieldPriorities[field]) {
                            const matchingHeader = columnHeaders.find(header => 
                                header.toLowerCase().includes(priority.toLowerCase()) ||
                                priority.toLowerCase().includes(header.toLowerCase())
                            );
                            if (matchingHeader) {
                                bestMatch = matchingHeader;
                                break;
                            }
                        }
                    }
                    
                    // Set the best match as selected
                    if (bestMatch) {
                        const optionToSelect = select.querySelector(`option[value="${bestMatch}"]`);
                        if (optionToSelect) {
                            optionToSelect.selected = true;
                        }
                    }
                }
                
                mappingGroup.appendChild(label);
                mappingGroup.appendChild(select);
                columnMapping.appendChild(mappingGroup);
            });

            mappingSection.classList.add('show');
            processBtn.disabled = false;
        }

        function processData() {
            // Get column mappings
            const mappings = {};
            let hasRequiredMappings = true;
            
            Object.keys(requiredFields).forEach(field => {
                const selectElement = document.getElementById(`mapping_${field}`);
                mappings[field] = selectElement.value;
                
                if (!mappings[field] && ['stud_firstname_', 'stud_lastname_', 'school', 'sdo'].includes(field)) {
                    hasRequiredMappings = false;
                }
            });

            if (!hasRequiredMappings) {
                showError('Please map at least Student First Name, Student Last Name, School, and SDO fields.');
                return;
            }

            showLoading(true);
            
            // Simulate processing delay for better UX
            setTimeout(() => {
                try {
                    processedData = transformData(rawData, mappings);
                    showLoading(false);
                    updatePreview();
                    updateStats();
                    downloadBtn.disabled = false;
                    showSuccess('Data processed successfully! You can now download the Excel file.');
                    statsSection.style.display = 'block';
                } catch (error) {
                    showLoading(false);
                    showError('Error processing data: ' + error.message);
                }
            }, 1500);
        }

        // Helper function to safely convert values to strings
        function safeStringConvert(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'string') return value;
            return String(value);
        }

        function transformData(data, mappings) {
            const result = {
                cases: [],
                teachers: [],
                schools: [],
                sdos: new Set(),
                duplicatesRemoved: 0,
                originalCount: 0
            };

            const seenStudents = new Set();
            const teacherSet = new Set();
            const schoolSet = new Set();

            // Initialize arrays directly instead of using sets with JSON.stringify
            result.teachers = [];
            result.schools = [];

            // Process each row and reshape from WIDE to LONG format
            data.forEach((row, rowIndex) => {
                // Determine how many students are in this row by checking for students with suffixes
                let studentCount = 0;
                
                // Check for students with suffixes _, _1, _2, etc. up to 30 students
                // Stop when we find an empty student (no gaps)
                for (let i = 0; i < 30; i++) {
                    let firstNameCol, lastNameCol;
                    
                    if (i === 0) {
                        // First student uses just underscore (e.g., stud_firstname_)
                        firstNameCol = mappings.stud_firstname_;
                        lastNameCol = mappings.stud_lastname_;
                    } else {
                        // Subsequent students use _1, _2, etc. (e.g., stud_firstname_1)
                        // Replace the trailing underscore with _1, _2, etc.
                        firstNameCol = mappings.stud_firstname_.slice(0, -1) + `_${i}`;
                        lastNameCol = mappings.stud_lastname_.slice(0, -1) + `_${i}`;
                    }
                    
                    console.log(`Checking student ${i}: ${firstNameCol} = "${row[firstNameCol]}", ${lastNameCol} = "${row[lastNameCol]}"`);
                    
                    const hasFirstName = row[firstNameCol] && String(row[firstNameCol]).trim() !== '';
                    const hasLastName = row[lastNameCol] && String(row[lastNameCol]).trim() !== '';
                    
                    if (hasFirstName || hasLastName) {
                        studentCount = i + 1;
                    } else {
                        // No more students in this row (they should be sequential)
                        console.log(`No student found at position ${i}, stopping search`);
                        break;
                    }
                }

                console.log(`Total students found in this row: ${studentCount}`);

                result.originalCount += studentCount;

                // Process each student in this row
                for (let i = 0; i < studentCount; i++) {
                    const suffix = i === 0 ? '_' : `_${i}`;
                    
                    // Map column names with proper suffix - fixed logic
                    let studentCols = {};
                    
                    if (i === 0) {
                        // First student uses exact field names
                        studentCols = {
                            firstName: mappings.stud_firstname_,
                            lastName: mappings.stud_lastname_,
                            gradeLevel: mappings.grade_level_,
                            respFirstName: mappings.resp_firstname_,
                            respLastName: mappings.resp_lastname_,
                            phone1: mappings.phone_1_,
                            phone2: mappings.phone_2_,
                            learnNumber: mappings.learn_number_,
                            respRelationCode: mappings.resp_relation_code_,
                            contacts: mappings.contacts_,
                            messengerAcct: mappings.messenger_acct_,
                            messengerLink: mappings.messenger_link_,
                            preferredPlatform: mappings.preferred_platform_
                        };
                    } else {
                        // Subsequent students: remove trailing underscore and add _1, _2, etc.
                        studentCols = {
                            firstName: mappings.stud_firstname_.slice(0, -1) + `_${i}`,
                            lastName: mappings.stud_lastname_.slice(0, -1) + `_${i}`,
                            gradeLevel: mappings.grade_level_.slice(0, -1) + `_${i}`,
                            respFirstName: mappings.resp_firstname_.slice(0, -1) + `_${i}`,
                            respLastName: mappings.resp_lastname_.slice(0, -1) + `_${i}`,
                            phone1: mappings.phone_1_.slice(0, -1) + `_${i}`,
                            phone2: mappings.phone_2_.slice(0, -1) + `_${i}`,
                            learnNumber: mappings.learn_number_.slice(0, -1) + `_${i}`,
                            respRelationCode: mappings.resp_relation_code_.slice(0, -1) + `_${i}`,
                            contacts: mappings.contacts_.slice(0, -1) + `_${i}`,
                            messengerAcct: mappings.messenger_acct_.slice(0, -1) + `_${i}`,
                            messengerLink: mappings.messenger_link_.slice(0, -1) + `_${i}`,
                            preferredPlatform: mappings.preferred_platform_.slice(0, -1) + `_${i}`
                        };
                    }

                    console.log(`Processing student ${i + 1} with columns:`, {
                        firstName: studentCols.firstName,
                        lastName: studentCols.lastName,
                        firstNameValue: row[studentCols.firstName],
                        lastNameValue: row[studentCols.lastName]
                    });

                    // Get student data using safe conversion
                    const studentFirst = safeStringConvert(row[studentCols.firstName]).trim();
                    const studentLast = safeStringConvert(row[studentCols.lastName]).trim();
                    
                    // Skip if no student name
                    if (!studentFirst && !studentLast) {
                        continue;
                    }

                    // Create student identifier for duplicate detection
                    const learnerNumber = safeStringConvert(row[studentCols.learnNumber]).trim();
                    const studentKey = `${studentFirst.toLowerCase()}_${studentLast.toLowerCase()}_${learnerNumber}`;
                    
                    if (seenStudents.has(studentKey)) {
                        result.duplicatesRemoved++;
                        continue;
                    }
                    seenStudents.add(studentKey);

                    // Clean and format names using safe conversion
                    const studentFirstName = properCase(studentFirst);
                    const studentLastName = properCase(studentLast);
                    const respFirstName = properCase(safeStringConvert(row[studentCols.respFirstName]).trim());
                    const respLastName = properCase(safeStringConvert(row[studentCols.respLastName]).trim());
                    const teacherFirstName = properCase(safeStringConvert(row[mappings.teacher_firstname]).trim());
                    const teacherLastName = properCase(safeStringConvert(row[mappings.teacher_lastname]).trim());

                    // Format respondent relation
                    const respRelationCode = safeStringConvert(row[studentCols.respRelationCode]);
                    let respRelation = 'Parent'; // Default
                    switch(respRelationCode) {
                        case '1': respRelation = 'Parent'; break;
                        case '2': respRelation = 'Aunt/Uncle'; break;
                        case '3': respRelation = 'Grandparent'; break;
                        case '4': respRelation = 'Sibling'; break;
                        case '5': respRelation = 'Guardian'; break;
                        case '6': respRelation = 'Other Relative'; break;
                        default: respRelation = 'Parent'; break;
                    }

                    // Format preferred platform - only use values found in actual data
                    const preferredPlatformCode = safeStringConvert(row[studentCols.preferredPlatform]);
                    let preferredPlatformText = 'Phone call'; // Default
                    switch(preferredPlatformCode) {
                        case '1': preferredPlatformText = 'Phone call'; break;
                        case '2': preferredPlatformText = 'Facebook Messenger audio call'; break;
                        // Only add more if found in your dataset
                        default: preferredPlatformText = 'Phone call'; break;
                    }

                    // Process case data - use text labels where available
                    const caseData = {
                        serialId: result.cases.length + 1,
                        formids: 'deped_nlc_baseline_form, deped_nlc_phone_change',
                        region: safeStringConvert(row[mappings.region_label] || row[mappings.region]).trim(),
                        division: safeStringConvert(row[mappings.sdo_label] || row[mappings.sdo]).trim(),
                        school_name: safeStringConvert(row[mappings.school_label] || row[mappings.school]).trim(),
                        old_student_name: `${studentFirstName} ${studentLastName}`.trim(),
                        grade_level: safeStringConvert(row[studentCols.gradeLevel]).trim(),
                        resp_name: `${respFirstName} ${respLastName}`.trim(),
                        resp_relation: respRelation,
                        encoding_teacher: `${teacherFirstName} ${teacherLastName}`.trim(),
                        contacts: safeStringConvert(row[studentCols.contacts]),
                        phone_1: cleanPhoneNumber(safeStringConvert(row[studentCols.phone1])),
                        phone_2: cleanPhoneNumber(safeStringConvert(row[studentCols.phone2])),
                        phone_1_name: `${respFirstName} ${respLastName}`.trim(),
                        phone_2_name: row[studentCols.phone2] ? `${respFirstName} ${respLastName}`.trim() : '',
                        learn_number: learnerNumber,
                        district: safeStringConvert(row[mappings.district_label] || row[mappings.district]).trim(),
                        messenger_account: safeStringConvert(row[studentCols.messengerAcct]),
                        messenger_link: safeStringConvert(row[studentCols.messengerLink]),
                        preferred_platform: preferredPlatformText,
                        // Keep IDs for reference
                        region_id: safeStringConvert(row[mappings.region]).trim(),
                        sdo_id: safeStringConvert(row[mappings.sdo]).trim(),
                        school_id: safeStringConvert(row[mappings.school]).trim(),
                        district_id: safeStringConvert(row[mappings.district]).trim()
                    };

                    result.cases.push(caseData);
                    result.sdos.add(caseData.division);

                    // Collect unique teachers (only once per row, not per student)
                    if (i === 0 && caseData.encoding_teacher && caseData.encoding_teacher.trim()) {
                        // Create a more robust teacher key using teacher name + school ID
                        const teacherKey = `${teacherFirstName.toLowerCase()}_${teacherLastName.toLowerCase()}_${caseData.school_name}`;
                        
                        if (!teacherSet.has(teacherKey)) {
                            teacherSet.add(teacherKey);
                            result.teachers.push({
                                sdo: caseData.division,
                                school_name: caseData.school_name,
                                teacher_first_name: teacherFirstName,
                                teacher_last_name: teacherLastName,
                                encoding_teacher: caseData.encoding_teacher,
                                district: caseData.district
                            });
                        }
                    }

                    // Collect unique schools (only once per row)
                    if (i === 0 && caseData.school_name && caseData.school_name.trim()) {
                        const schoolKey = `${caseData.school_name}_${caseData.division}`;
                        
                        if (!schoolSet.has(schoolKey)) {
                            schoolSet.add(schoolKey);
                            result.schools.push({
                                sdo: caseData.division,
                                school_name: caseData.school_name,
                                district: caseData.district
                            });
                        }
                    }
                }
            });

            // Remove the conversion step since we're building arrays directly
            result.sdos = Array.from(result.sdos).filter(sdo => sdo);

            return result;
        }

        function properCase(str) {
            return str.replace(/\w\S*/g, (txt) => 
                txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
        }

        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            // Remove non-numeric characters and handle basic formatting
            const cleaned = phone.toString().replace(/\D/g, '');
            return cleaned;
        }

        function updatePreview() {
            if (!processedData) return;

            const preview = `CASES DATA PREVIEW (WIDE FORMAT PROCESSED):
==========================================

📊 SUMMARY STATISTICS:
• Total Cases Generated: ${processedData.cases.length}
• Original Records Processed: ${processedData.originalCount}
• Duplicates Removed: ${processedData.duplicatesRemoved}
• Unique Teachers: ${processedData.teachers.length}
• Unique Schools: ${processedData.schools.length}
• SDO IDs: ${processedData.sdos.join(', ')}

🔄 WIDE TO LONG CONVERSION:
• Detected multiple students per row in WIDE format
• Reshaped data to one student per case
• Processed students with suffixes: _, _1, _2, etc.

📝 SAMPLE CASES (First 3):
${processedData.cases.slice(0, 3).map((c, i) => `
Case ${i + 1}:
  Student: ${c.old_student_name}
  Grade: ${c.grade_level}
  School ID: ${c.school_name}
  SDO ID: ${c.division}
  Region ID: ${c.region}
  Teacher: ${c.encoding_teacher}
  Respondent: ${c.resp_name} (${c.resp_relation})
  Phone: ${c.phone_1}
`).join('')}

👥 SAMPLE TEACHERS (First 3):
${processedData.teachers.slice(0, 3).map((t, i) => `
Teacher ${i + 1}:
  Name: ${t.encoding_teacher}
  First: ${t.teacher_first_name}
  Last: ${t.teacher_last_name}
  School ID: ${t.school_name}
  SDO ID: ${t.sdo}
  District ID: ${t.district}
`).join('')}

🏫 UNIQUE TEACHER IDENTIFICATION:
• Teachers identified by: Name + School ID
• Prevents duplicates across multiple student entries
• Each teacher appears only once in teachers dataset

📋 EXCEL FILE WILL CONTAIN:
• Individual SDO sheets for cases (by SDO ID)
• Teachers sheet with enumerator IDs  
• Schools sheet for reference
• All numeric IDs preserved as entered

⚠️  NOTE: 
Region/SDO/School are numeric IDs as in your source data.
You may want to add a lookup table to convert to names.`;

            previewArea.textContent = preview;
        }

        function updateStats() {
            if (!processedData) return;

            // Calculate unique students
            const uniqueStudentNames = new Set(processedData.cases.map(c => c.old_student_name.toLowerCase()));

            document.getElementById('totalRecords').textContent = processedData.cases.length;
            document.getElementById('uniqueStudents').textContent = uniqueStudentNames.size;
            document.getElementById('totalTeachers').textContent = processedData.teachers.length;
            document.getElementById('totalSchools').textContent = processedData.schools.length;
            document.getElementById('totalSDOs').textContent = processedData.sdos.length;
        }

        function downloadExcel() {
            if (!processedData) return;

            showLoading(true);
            
            // Simulate Excel generation delay
            setTimeout(() => {
                try {
                    generateExcelFile();
                    showLoading(false);
                    showSuccess('Excel file downloaded successfully!');
                } catch (error) {
                    showLoading(false);
                    showError('Error generating Excel file: ' + error.message);
                }
            }, 2000);
        }

        function generateExcelFile() {
            const wb = XLSX.utils.book_new();
            
            // Create teachers sheet with proper data structure
            const teachersData = processedData.teachers.map((teacher, index) => ({
                'sdoid': `SDO${String(index + 1).padStart(3, '0')}`, // Sample SDO ID - to be filled manually
                'sdo': teacher.sdo,
                'school_name': teacher.school_name,
                'teacher_first_name': teacher.teacher_first_name,
                'teacher_last_name': teacher.teacher_last_name,
                'enumerator_id': `${teacher.teacher_first_name.charAt(0)}${teacher.teacher_last_name}_${teacher.sdo_id}`,
                'enumerator_name': `${teacher.teacher_first_name} ${teacher.teacher_last_name}`,
                'users': `user_${teacher.school_id}`,
                'district': teacher.district
            }));
            
            console.log('Teachers data for Excel:', teachersData);
            
            const teachersWS = XLSX.utils.json_to_sheet(teachersData);
            XLSX.utils.book_append_sheet(wb, teachersWS, 'teachers');
            
            // Create schools sheet
            const schoolsData = processedData.schools.map((school, index) => ({
                'sdo': school.sdo,
                'district': school.district,
                'school_name': school.school_name,
                'users': `user_${school.school_name.toString().padStart(6, '0')}` // Generated username based on school ID
            }));
            
            console.log('Schools data for Excel:', schoolsData);
            
            const schoolsWS = XLSX.utils.json_to_sheet(schoolsData);
            XLSX.utils.book_append_sheet(wb, schoolsWS, 'schools');
            
            // Create SDO-specific sheets for cases
            processedData.sdos.forEach(sdoId => {
                if (!sdoId) return;
                
                const sdoCases = processedData.cases.filter(c => c.sdo_id === sdoId);
                const sheetName = `SDO_${sdoId}`;
                
                const sdoData = sdoCases.map((caseItem, index) => ({
                    'id': `=CONCAT("${sdoId}_",ROW()-1)`, // Excel formula for auto-incrementing ID with SDO prefix
                    'formids': caseItem.formids,
                    'region': caseItem.region,
                    'division': caseItem.division,
                    'school_name': caseItem.school_name,
                    'resp_name': caseItem.resp_name,
                    'resp_relation': caseItem.resp_relation,
                    'old_student_name': caseItem.old_student_name,
                    'grade_level': caseItem.grade_level,
                    'encoding_teacher': caseItem.encoding_teacher,
                    'contacts': caseItem.contacts,
                    'phone_1': caseItem.phone_1,
                    'phone_2': caseItem.phone_2,
                    'phone_1_name': caseItem.phone_1_name,
                    'phone_2_name': caseItem.phone_2_name,
                    'messenger_account': caseItem.messenger_account,
                    'messenger_link': caseItem.messenger_link,
                    'preferred_platform': caseItem.preferred_platform,
                    'learn_number': caseItem.learn_number,
                    'district': caseItem.district,
                    'region_id': caseItem.region_id,
                    'sdo_id': caseItem.sdo_id,
                    'school_id': caseItem.school_id,
                    'district_id': caseItem.district_id,
                    'enumerators': `=IFERROR(XLOOKUP(J${index + 2},teachers!G:G,teachers!F:F,""),"")`, // Lookup enumerator ID
                    'users': `=IFERROR(XLOOKUP(P${index + 2},teachers!F:F,teachers!H:H,""),"")` // Lookup users
                }));
                
                const sdoWS = XLSX.utils.json_to_sheet(sdoData);
                XLSX.utils.book_append_sheet(wb, sdoWS, sheetName);
            });
            
            // Create summary sheet - FIX: Define sdoSummaryData properly
            const sdoSummaryData = processedData.sdos.map(sdoId => {
                // Filter cases for this specific SDO
                const sdoCases = processedData.cases.filter(c => c.sdo_id === sdoId);
                const currentSdoName = sdoCases.length > 0 ? sdoCases[0].division : `SDO_${sdoId}`;
                
                return { 
                    'Item': `• ${currentSdoName} (ID: ${sdoId})`, 
                    'Value': sdoCases.length + ' cases'
                };
            });
            
            const summaryData = [
                { 'Item': 'Processing Summary', 'Value': '' },
                { 'Item': 'Total Cases Generated', 'Value': processedData.cases.length },
                { 'Item': 'Original Records Processed', 'Value': processedData.originalCount },
                { 'Item': 'Duplicates Removed', 'Value': processedData.duplicatesRemoved },
                { 'Item': 'Unique Teachers', 'Value': processedData.teachers.length },
                { 'Item': 'Unique Schools', 'Value': processedData.schools.length },
                { 'Item': 'SDOs Processed', 'Value': processedData.sdos.length },
                { 'Item': '', 'Value': '' },
                { 'Item': 'SDO IDs Included:', 'Value': '' },
                ...sdoSummaryData
            ];
            
            const summaryWS = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, 'summary');
            
            // Download the file
            const fileName = `cases_deped_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function resetForm() {
            rawData = null;
            processedData = null;
            columnHeaders = [];
            
            fileInfo.classList.remove('show');
            mappingSection.classList.remove('show');
            statsSection.style.display = 'none';
            
            processBtn.disabled = true;
            downloadBtn.disabled = true;
            
            previewArea.textContent = 'Upload a file to see the preview of generated cases...';
            hideMessages();
            
            fileInput.value = '';
        }

        function showLoading(show) {
            loading.classList.toggle('show', show);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            errorMessage.classList.remove('show');
        }

        function hideMessages() {
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
